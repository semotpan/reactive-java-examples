@Bean
XmlMapper xmlMapper() {
    XmlMapper xmlMapper = new XmlMapper();
    xmlMapper.registerModule(new JavaTimeModule());
    xmlMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
    xmlMapper.configure(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY, true);

    SimpleModule mod = new SimpleModule("XmlDocumentPoly");
    mod.addDeserializer(XmlDocument.class, new XmlDocumentDeserializer());
    xmlMapper.registerModule(mod);
    return xmlMapper;
}

@Bean
XmlReader xmlReader(XmlMapper xmlMapper) {
    return XmlReader.builder(xmlMapper)
        .register(m -> m.rootName("invoices"), Invoices.class)
        .register(m -> m.rootName("transactions")
                       .hasPath("/transactions/transaction/amount[@Ccy]"),
                  Transactions.class)
        .register(m -> m.namespace("urn:iso:std:iso:20022:tech:xsd:camt.054.001.04"),
                  Camt54.class)
        .fallback(UnresolvedXml.class)
        .build();
}




@Slf4j
@RequiredArgsConstructor
@Component
final class XmlReactiveSftpMessageHandler implements ReactiveMessageHandler {

    private final XmlReader xmlReader;
    private final DocumentHandler documentHandler; // your handler for ParsedDocument<?>

    @Override
    public Mono<Void> handleMessage(Message<?> message) {
        String filename = (String) message.getHeaders().getOrDefault("file_name", "unknown.xml");
        byte[] bytes = (byte[]) message.getPayload(); // or read from a Resource/Path

        return xmlReader.read(bytes, filename)                 // Mono<ParsedDocument<?>>
            .flatMap(documentHandler::handle)                  // Mono<Void> (your impl)
            .doOnError(ex -> log.error("Failed to process {}: {}", filename, ex.getMessage(), ex))
            .onErrorResume(ex -> documentHandler.handle(
                ParsedDocument.error(filename, "Reader error: " + ex.getMessage())
            ))
            .then();
    }
}


@Component
@Slf4j
class LoggingDocumentHandler implements DocumentHandler {

    @Override
    public Mono<Void> handle(ParsedDocument<?> doc) {
        if (doc.error() != null) {
            log.warn("File {} unresolved: {}", doc.filename(), doc.error());
            return Mono.empty();
        }
        log.info("File {} -> payload type: {}", doc.filename(),
                 doc.payload().getClass().getSimpleName());

        // TODO: persist, publish event, etc.
        return Mono.empty();
    }
}
